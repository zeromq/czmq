<class
    name = "zgossip"
    title = "zgossip server"
    proto = "zgossip_msg"
    script = "zproto_server_c"
    >
    This is a server implementation of the ZeroMQ Gossip Discovery Protocol
    <include filename = "license.xml" />

    <state name = "start" inherit = "external">
        <!-- Peer says HELLO and we send it all known services -->
        <event name = "HELLO" next = "have service">
            <action name = "get first service" />
        </event>
    </state>

    <state name = "have service">
        <event name = "ok">
            <action name = "send" message = "ANNOUNCE" />
            <action name = "get next service" />
        </event>
        <event name = "finished" next = "connected" />
    </state>

    <state name = "connected" inherit = "external">
        <!-- Peer announces a new service -->
        <event name = "ANNOUNCE">
            <action name = "store service if new" />
        </event>
        <!-- Peer signals it's alive -->
        <event name = "PING">
            <action name = "send" message = "PONG" />
        </event>
        <!-- Forward a new service to this client -->
        <event name = "forward">
            <action name = "get service to forward" />
            <action name = "send" message = "ANNOUNCE" />
        </event>
    </state>

    <!-- Superstate for external states -->
    <state name = "external">
        <!-- All other protocol messages are invalid -->
        <event name = "*">
            <action name = "send" message = "INVALID" />
            <action name = "terminate" />
        </event>
        
        <!-- This built-in event hits on a connection timeout -->
        <event name = "expired">
            <action name = "terminate" />
        </event>
    </state>
</class>
